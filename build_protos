# Used to build proto files

FROM python:3.10-alpine3.17 as python-base

ENV PYTHONUNBUFFERED=1 \
    PYTHONFAULTHANDLER=1 \
    PIP_DEFAULT_TIMEOUT=100 \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    PIP_helloNO_CACHE_DIR=1 \
    POETRY_VERSION=1.3

WORKDIR /app

RUN apk add --no-cache gcc musl-dev libpq-dev
RUN pip install --no-cache "poetry==$POETRY_VERSION"
RUN python -m venv /venv

COPY backend/pyproject.toml backend/poetry.lock ./
RUN poetry export -f requirements.txt | /venv/bin/pip install -r /dev/stdin


FROM node:16-alpine3.17 as node-base
WORKDIR /app
RUN npm install grpc grpc-tools grpc_tools_node_protoc_ts


FROM python-base as main
WORKDIR /app
# COPY --from=python-base /venv /venv
# COPY --from=python-base /usr/local/bin/python /usr/local/bin/python
RUN apk add --no-cache nodejs
COPY --from=node-base /app/node_modules ./node_modules
COPY proto/ proto/

CMD /venv/bin/python -m grpc_tools.protoc \
    -I./proto \
    --plugin=protoc-gen-ts=./node_modules/.bin/protoc-gen-ts \
    --ts_out=./generated \
    --python_out=./generated \
    --pyi_out=./generated \
    --grpc_python_out=./generated \
    ./proto/*.proto
